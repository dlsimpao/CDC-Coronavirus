Time Series Analysis ARIMA basic model

https://medium.com/@kfoofw/seasonal-lags-sarima-model-fa671a858729
```{r, message = FALSE}

library(ggplot2)
library(tidyquant)
library(tidyverse)
library(dplyr)
library(data.table)
library(corrplot)
library(gridExtra)
library(forecast)
library(tseries)
library(TSA)
library(tibble)
library(TTR)
library(xts)
library(dygraphs)
library(assertthat)


library(sarima)
library(astsa)
```

# Import time series data
```{r}
cdc_dec20_ts = read.csv('cdc_dec20_ts.csv') %>% 
  transmute(Date = as.Date(X2020.01.01),
            Values = X2) %>% 
  mutate(Group = "Given")

cdc_xts = xts(cdc_dec20_ts$Values, order.by = cdc_dec20_ts$Date)

cdc_may21_ts = read.csv('cdc_may21_ts.csv') %>% 
  transmute(Date = as.Date(X2020.01.01),
            Values = X15) %>% 
  mutate(Group = "Given")

cdc_xts_may = xts(cdc_may21_ts$Values, order.by = cdc_may21_ts$Date)


cdc_allmay.ts = read.csv('cdc_allmay_positive_cases_ts.csv') %>% 
  transmute(Date = as.Date(X2020.01.01), Values = X45) %>% 
  mutate(Group = "Given")

cdc_xts_allmay = xts(cdc_allmay.ts$Values, order.by = cdc_allmay.ts$Date)
```

# Plot
```{r}
dygraph(cdc_xts, xlab = "Time", ylab = "Cases", main = "Time Series")

```

```{r}
dygraph(cdc_xts_may, xlab = "Time", ylab = "Cases", main = "Time Series")
```

```{r}
######################## Include in report
dygraph(cdc_xts_allmay, xlab = "Time", ylab = "Cases", main = "Time Series")
```




# Stationarity Testing
```{r}
# test for stationarity
# Augmented Dickey-Fuller test
adf.test(cdc_xts, alternative = "stationary", k = 0)
```

```{r}
# test for stationarity
# Augmented Dickey-Fuller test
adf.test(cdc_xts_may, alternative = "stationary", k = 0)
```

```{r}
# test for stationarity
# Augmented Dickey-Fuller test
adf.test(cdc_xts_allmay, alternative = "stationary", k = 0)
```

```{r}
cdc_xts_diff1 = diff(cdc_xts)
plot.xts(cdc_xts_diff1, col = "dark green")
```

```{r}
cdc_xts_may_diff1 = diff(cdc_xts_may)
plot.xts(cdc_xts_may_diff1, col = "dark green")
```

```{r}
adf.test(na.omit(cdc_xts_diff1), alternative = "stationary", k = 0)
```

```{r}
adf.test(na.omit(cdc_xts_may_diff1), alternative = "stationary", k = 0)
```

```{r}
findfrequency(cdc_xts)
findfrequency(cdc_xts_diff1)

findfrequency(cdc_xts_may)
findfrequency(cdc_xts_may_diff1)
```

# ACF/PACF plot: Nov xts
```{r}
#Acf gradually declines.
#Acf(cdc_xts_diff1, lag.max = 60)
acf2(diff(cdc_xts),8)
cdc_nov_acfObj = acf2(diff(diff(cdc_xts),7),8)
```

# ACF: May xts
```{r}
#Acf gradually declines.
#Acf(cdc_xts_may_diff1, lag.max = 60)

acf2(diff(cdc_xts_may),12)

#We're using this one 
cdc_may_acfObj = acf2(diff(diff(cdc_xts_may),7))
```

#ACF/PACF: all May xts
```{r}
#Acf gradually declines.
#Acf(cdc_xts_may_diff1, lag.max = 60)

acf2(cdc_xts_allmay)
acf2(diff(cdc_xts_allmay))
acf2(diff(cdc_xts_allmay),12)
#We're using this one 
cdc_allmay_acfObj = acf2(diff(diff(cdc_xts_allmay),7))
```

#https://towardsdatascience.com/identifying-ar-and-ma-terms-using-acf-and-pacf-plots-in-time-series-forecasting-ccb9fd073db8

The plots suggests, we use an autoregressive model with lag = 7. If ACF plot shows sharp drop off and PACF plot shows gradual decline, we go with MA model. If ACF plot shows gradual decline and PACF shows sharp drop off, we go with AR model. If both shows gradual decline, we use ARMA model.


```{r}
acf2(diff(diff(cdc_xts),7),12)
sarima(cdc_xts, p = 0, d = 1, q = 2, P = 2, D = 1, Q = 2, 7)
sarima(cdc_xts, p = 2, d = 1, q = 2, P = 2, D = 1, Q = 2, 7)
```

#Not using
```{r}
acf2(diff(diff(cdc_xts_may),7),12)
sarima(cdc_xts_may, p = 0, d = 1, q = 2, P = 2, D = 1, Q = 2, 7)
sarima(cdc_xts_may, p = 2, d = 1, q = 2, P = 2, D = 1, Q = 2, 7)
```
# Use this one
```{r}
####################### Include in report
acf2(diff(cdc_xts_allmay))
acf2(diff(diff(cdc_xts_allmay),7))

#sarima(cdc_xts_allmay, p = 0, d = 1, q = 2, P = 2, D = 1, Q = 2, 7)

####################### Include in report
sarima(cdc_xts_allmay, p = 2, d = 1, q = 2, P = 2, D = 1, Q = 2, 7)
```
```{r}
days = 5
sarima.allmay = sarima.for(cdc_xts_allmay, days, p = 2, d = 1, q = 2, P = 2, D = 1, Q = 2, 7) 

sarima.allmay_pred = sarima.may$pred %>% map(~ max(0,.x)) %>% unlist()


allmay_pred_df = data.frame(Date = seq(from = tail(cdc_may21_ts$Date,1)+1, by = 1, length.out = days),
                         Values = sarima.may_pred,
                         Group = "Forecasted")

allmay_full = rbind(cdc_allmay.ts, allmay_pred_df)

ggplot(data = allmay_full, aes(x = Date, y = Values, color = Group, group = 1)) + geom_line() + coord_x_date(xlim = c("2021-03-01","2021-15-05"), ylim = (c(-10,20000))) + ggtitle("Time Series")
```

#Comparison with the ground truth, predicting the winter surge
```{r}
days = 60
apr_oct2020 = cdc_allmay.ts %>% filter(Date <= "2020-10-31")

apr_oct2020.xts = xts(apr_oct2020$Values, order.by = apr_oct2020$Date)

```

```{r}
acf2(diff(apr_oct2020.xts))
acf2(diff(diff(apr_oct2020.xts),7))
```

```{r}
days = 60
sarima.aproct = sarima.for(apr_oct2020.xts, days, p = 2, d = 1, q = 2, P = 2, D = 1, Q = 2, 7)

aproct_pred_df = data.frame(Date = seq(from = tail(apr_oct2020$Date,1)+1, by = 1, length.out = days),
                         Values = sarima.aproct$pred,
                         Group = "Forecasted")

aproct_full = rbind(apr_oct2020, aproct_pred_df)

aproct_predplot = ggplot(data = aproct_full, aes(x = Date, y = Values, color = Group, group = 1)) + geom_line() + coord_x_date(ylim = (c(-10,80000))) + ggtitle("Time Series")

aproct_actplot = ggplot(data = cdc_allmay.ts, aes(x = Date, y = Values)) + geom_line() + coord_x_date(xlim = c("2020-01-01","2021-01-01"),ylim = (c(-10,80000))) + ggtitle("Time Series")

aproct_predplot
aproct_actplot
```




