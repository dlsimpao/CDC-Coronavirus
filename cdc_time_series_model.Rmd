Time Series Analysis ARIMA basic model

https://medium.com/@kfoofw/seasonal-lags-sarima-model-fa671a858729
```{r, message = FALSE}

library(ggplot2)
library(tidyquant)
library(dplyr)
library(data.table)
library(corrplot)
library(gridExtra)
library(forecast)
library(tseries)
library(TSA)
library(tibble)
library(TTR)
library(xts)
library(dygraphs)
library(assertthat)
library(sarima)
library(astsa)
```

# Import time series data
```{r}
cdc_dec20_ts = read.csv('cdc_dec20_ts.csv') %>% 
  transmute(Date = as.Date(X2020.01.01),
            Values = X2) %>% 
  mutate(Group = "Given")

cdc_xts = xts(cdc_dec20_ts$Values, order.by = cdc_dec20_ts$Date)

cdc_may21_ts = read.csv('cdc_may21_ts.csv') %>% 
  transmute(Date = as.Date(X2020.01.01),
            Values = X15) %>% 
  mutate(Group = "Given")

cdc_xts_may = xts(cdc_may21_ts$Values, order.by = cdc_may21_ts$Date)
```

# Plot
```{r}
dygraph(cdc_xts, xlab = "Time", ylab = "Cases", main = "Time Series")

```

```{r}
dygraph(cdc_xts_may, xlab = "Time", ylab = "Cases", main = "Time Series")
```

# Stationarity Testing
```{r}
# test for stationarity
# Augmented Dickey-Fuller test
adf.test(cdc_xts, alternative = "stationary", k = 0)
```

```{r}
# test for stationarity
# Augmented Dickey-Fuller test
adf.test(cdc_xts_may, alternative = "stationary", k = 0)
```

```{r}
cdc_xts_diff1 = diff(cdc_xts)
plot.xts(cdc_xts_diff1, col = "dark green")
```

```{r}
cdc_xts_may_diff1 = diff(cdc_xts_may)
plot.xts(cdc_xts_may_diff1, col = "dark green")
```

```{r}
adf.test(na.omit(cdc_xts_diff1), alternative = "stationary", k = 0)
```

```{r}
adf.test(na.omit(cdc_xts_may_diff1), alternative = "stationary", k = 0)
```

```{r}
findfrequency(cdc_xts)
findfrequency(cdc_xts_diff1)

findfrequency(cdc_xts_may)
findfrequency(cdc_xts_may_diff1)
```

# ACF/PACF plot: Nov xts
```{r}
#Acf gradually declines.
#Acf(cdc_xts_diff1, lag.max = 60)
acf2(diff(cdc_xts),8)
cdc_nov_acfObj = acf2(diff(diff(cdc_xts),7),8)
```

# ACF: May xts
```{r}
#Acf gradually declines.
#Acf(cdc_xts_may_diff1, lag.max = 60)

acf2(diff(cdc_xts_may),12)

#We're using this one 
cdc_may_acfObj = acf2(diff(diff(cdc_xts_may),7),12)
```

#https://towardsdatascience.com/identifying-ar-and-ma-terms-using-acf-and-pacf-plots-in-time-series-forecasting-ccb9fd073db8

The plots suggests, we use an autoregressive model with lag = 7. If ACF plot shows sharp drop off and PACF plot shows gradual decline, we go with MA model. If ACF plot shows gradual decline and PACF shows sharp drop off, we go with AR model. If both shows gradual decline, we use ARMA model.

# Training the ARIMA Model
#pre Nov arima
# ```{r}
# cdc_arima_preNov_702 <- auto.arima(head(cdc_xts, -32), max.p = 7, max.q = 0, max.d = 2) # excluding last 240 time series as test data
# print(cdc_arima_preNov_702)
# ```
# 
# 
# ```{r}
# cdc_arima_preNov_732 <- auto.arima(head(cdc_xts, -32), max.p = 7, max.q = 3, max.d = 2) # excluding last 240 time series as test data
# print(cdc_arima_preNov_732)
# ```
# 
# # May auto.arima
# ```{r}
# cdc_arima_May_702 <- auto.arima(head(cdc_xts_may, -32), max.p = 7, max.q = 0, max.d = 2) # excluding last 240 time series as test data
# print(cdc_arima_May_702)
# ```
# 
# ```{r}
# cdc_arima_May_732 <- auto.arima(head(cdc_xts_may, -32), max.p = 7, max.q = 3, max.d = 2) # excluding last 240 time series as test data
# print(cdc_arima_May_732)
# ```

```{r}
acf2(diff(diff(cdc_xts),7),12)
sarima(cdc_xts, p = 0, d = 1, q = 2, P = 2, D = 1, Q = 2, 7)
sarima(cdc_xts, p = 2, d = 1, q = 2, P = 2, D = 1, Q = 2, 7)
```

```{r}
acf2(diff(diff(cdc_xts_may),7),12)
sarima(cdc_xts_may, p = 0, d = 1, q = 2, P = 2, D = 1, Q = 2, 7)
sarima(cdc_xts_may, p = 2, d = 1, q = 2, P = 2, D = 1, Q = 2, 7)
```



```{r}
days = 5
sarima.may = sarima.for(cdc_xts_may, days, p = 2, d = 1, q = 2, P = 2, D = 1, Q = 2, 7) 

sarima.may_pred = sarima.may$pred %>% map(~max(0,.x)) %>% unlist()



may_pred_df = data.frame(Date = seq(from = tail(cdc_may21_ts$Date,1)+1, by = 1, length.out = days),
                         Values = sarima.may_pred,
                         Group = "Forecasted")

may_all = rbind(cdc_may21_ts, may_pred_df)

ggplot(data = may_all, aes(x = Date, y = Values, color = Group, group = 1)) + geom_line() + coord_x_date(xlim = c("2021-03-01","2021-15-05"), ylim = (c(-10,5500))) + ggtitle("Time Series")
```
```{r}
sarima.for(cdc_xts_may, days, p = 2, d = 1, q = 2, P = 2, D = 1, Q = 2, 7) 
```
```{r}
days = 31
sarima.2020 = sarima.for(cdc_xts, days, p = 2, d = 1, q = 2, P = 2, D = 1, Q = 2, 7) 

sarima.2020= sarima.2020$pred %>% map(~max(0,.x)) %>% unlist()



pred2020_df = data.frame(Date = seq(from = tail(cdc_dec20_ts$Date,1)+1, by = 1, length.out = days),
                         Values = sarima.2020,
                         Group = "Forecasted")

twenty20_all = rbind(cdc_dec20_ts, pred2020_df)

ggplot(data = twenty20_all, aes(x = Date, y = Values, color = Group, group = 1)) + geom_line() + coord_x_date(xlim = c("2020-01-01","2020-31-12"))
```

```{r}
ggplot(data = may_all, aes(x = Date, y = Values, group = 1)) + geom_line() + coord_x_date(xlim = c("2020-01-01","2020-12-15"))
```

```{r}
sarima.for(cdc_xts, 5, p = 2, d = 1, q = 2, P = 2, D = 1, Q = 2, 7)
```

