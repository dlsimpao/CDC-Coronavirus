```{r}
library(tidyverse)

#visualization
library(ggplot2)
library(plotly)
library(hrbrthemes)

#time series
library(xts)
library(astsa)
library(forecast)
library(tsbox)
library(tseries)
```

#IMPORT DATA
```{r}
cdc_dec20_ts = read.csv('cdc_dec20_ts.csv') %>% 
  rename(Date = X2020.01.01, Values = X2)

cdc_preNov_ts =  cdc_dec20_ts %>% 
  mutate(Date = as.Date(Date)) %>% 
  filter(Date <= as.Date("2020-10-31"))

cdc_Nov2020_df = cdc_dec20_ts %>% 
  mutate(Date = as.Date(Date)) %>% 
  filter(Date > as.Date("2020-10-31")) 

cdc_Nov2020_ts = xts(cdc_Nov2020_df$Values, order.by = cdc_Nov2020_df$Date)
cdc_Nov2020_ts
```

#time series - base plot
```{r}
plot(cdc_preNov_ts$Values, type = 'l')
```
#time series - ggplot
```{r}
ggplot(data = cdc_preNov_ts, aes(x = Date, y = Values)) +
  geom_line() +
  xlab("")
```

# Detrending by differencing
```{r}
cdc_d2_ts = diff(cdc_preNov_ts$Values, lag = 1, differences = 1)
cdc_preNov_ts = cdc_preNov_ts %>% mutate(diff = c(NA,cdc_d2_ts))
#na.omit(cdc_d2_ts)
  
plot(cdc_d2_ts, type = 'l')
ggplot(data = as.data.frame(cdc_preNov_ts), aes(x = Date, y = diff)) +
  geom_line() +
  xlab("")
```

```{r}
adf.test(na.omit(cdc_preNov_ts$diff))
```

```{r}
acf(na.omit(cdc_preNov_ts$diff))
```

```{r}
pacf(na.omit(cdc_preNov_ts$diff))
```

```{r}
# arima has a auto.arima function which gives us the ideal arima model based on our data.
cdc_arima <- auto.arima(na.omit(cdc_preNov_ts$diff))
cdc_arima


```

```{r}
# lets use the auto.arima function to forecast 3 weeks

forecast1 <- forecast(cdc_arima, h=30)
additional_deaths <- round(sum(forecast1$upper[,2]),0)
# [1] 18589

# total_number_of_deaths <- round(sum(dat_US_Analysis$new_deaths)+additional_deaths,0)
# # [1] 171903

plot(forecast1)

```

```{r}

# lets use the auto.arima function to forecast 3 months
forecast2 <- forecast(object = cdc_arima, h = 90)
#additional_deaths2 <- round(sum(forecast2$upper[,2]),0)
# [1] 82653

#total_number_of_deaths2 <- round(sum(dat_US_Analysis$new_deaths)+additional_deaths2,0)
# [1] 235967
plot(forecast2)
```

# Model Evaluation

```{r}
accuracy(cdc_arima)
```

```{r}
modelcv = CVar(na.omit(cdc_preNov_ts$diff), k = 5, lambda = 0.15)
print(modelcv)
```

#Work on this later

```{r}
# autoplot(ts(cdc_preNov_ts$diff), series = "Data") +
#   autolayer(modelcv$testfit, series = "Fits") +
#   autolayer(modelcv$residuals, series = "Residuals")
# 
# ggAcf(modelcv$residuals)
```

```{r}
# cdc_arima %>% 
#   forecast(h = 21) %>% 
#   autoplot() 

plot(cdc_arima %>% forecast(h = 21))
lines(cdc_Nov2020_df, col = "red")

#nov = ggplot(cdc_Nov2020_df, aes(x = Date, y = Values)) + geom_line()
```